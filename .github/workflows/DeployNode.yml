name: Version, Tag, Release & Package (packagejson)

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - develop

jobs:
  versioning-and-release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      full_tag: ${{ steps.version.outputs.full_tag }}
      is_latest: ${{ steps.version.outputs.is_latest }}
    steps:
      - name: Checkout du d√©p√¥t
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: R√©cup√©rer la version actuelle depuis package.json
        id: get_version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "CURRENT_VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Version actuelle: $VERSION"

      - name: Incr√©menter la version en fonction de la branche source de la PR
        id: increment_version
        run: |
          CURRENT_VERSION=${{ env.CURRENT_VERSION }}
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"
          
          echo "Branche source: $BRANCH_NAME"
          echo "Branche cible: $TARGET_BRANCH"
          
          # Nettoyer la version existante (enlever les suffixes -pre-prod)
          CLEAN_VERSION=$(echo $CURRENT_VERSION | sed 's/-pre-prod//')
          echo "Version nettoy√©e: $CLEAN_VERSION"
          
          # D√©couper la version en MAJOR.MINOR.PATCH
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CLEAN_VERSION"
          echo "Version d√©compos√©e: MAJOR=$MAJOR, MINOR=$MINOR, PATCH=$PATCH"
          
          # Incr√©menter la version selon le type de branche source
          case $BRANCH_NAME in
            feat/*|feature/*)
              MINOR=$((MINOR + 1))
              PATCH=0
              echo "üöÄ Incr√©mentation mineure (feature)"
              ;;
            fix/*|hotfix/*)
              PATCH=$((PATCH + 1))
              echo "üêõ Incr√©mentation patch (fix)"
              ;;
            *breaking*|*major*)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              echo "üí• Incr√©mentation majeure (breaking change)"
              ;;
            *)
              echo "‚ÑπÔ∏è Pas d'incr√©mentation automatique"
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "Nouvelle version calcul√©e: $NEW_VERSION"
          
          # Ajouter le suffixe selon la branche cible
          if [[ "$TARGET_BRANCH" == "develop" ]]; then
            FULL_VERSION="${NEW_VERSION}-pre-prod"
            IS_LATEST="false"
            echo "üß™ Version pre-prod: $FULL_VERSION"
          elif [[ "$TARGET_BRANCH" == "main" ]]; then
            FULL_VERSION="${NEW_VERSION}"
            IS_LATEST="true"
            echo "‚úÖ Version stable: $FULL_VERSION"
          fi
          
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV
          echo "IS_LATEST=$IS_LATEST" >> $GITHUB_ENV

      - name: Extraire le changelog depuis la description de la PR
        id: extract_changelog
        run: |
          PR_BODY='${{ github.event.pull_request.body }}'
          
          # Extraire le contenu apr√®s #changelog
          if echo "$PR_BODY" | grep -q "#changelog"; then
            CHANGELOG=$(echo "$PR_BODY" | sed -n '/#changelog/,$p' | sed '1d' | sed '/^[[:space:]]*$/d')
          else
            CHANGELOG="- Mise √† jour vers la version ${{ env.FULL_VERSION }}"
          fi
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Mise √† jour vers la version ${{ env.FULL_VERSION }}"
          fi
          
          echo "üìù Changelog extrait:"
          echo "$CHANGELOG"
          
          # Sauvegarder le changelog dans les variables d'environnement
          {
            echo 'CHANGELOG<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Mettre √† jour la version dans package.json
        id: version
        run: |
          echo "üìù Mise √† jour de package.json avec la version: ${{ env.FULL_VERSION }}"
          jq --arg version "${{ env.FULL_VERSION }}" '.version = $version' package.json > tmp.json && mv tmp.json package.json
          
          # V√©rifier que la mise √† jour a fonctionn√©
          NEW_VERSION_CHECK=$(jq -r '.version' package.json)
          echo "‚úÖ package.json mis √† jour. Version v√©rifi√©e: $NEW_VERSION_CHECK"
          
          echo "version=${{ env.NEW_VERSION }}" >> $GITHUB_OUTPUT
          echo "full_tag=${{ env.FULL_VERSION }}" >> $GITHUB_OUTPUT
          echo "is_latest=${{ env.IS_LATEST }}" >> $GITHUB_OUTPUT

      - name: Commit and push the updated package.json
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add package.json
          git commit -m "üîñ Update version to ${{ env.FULL_VERSION }}"
          git push origin ${{ github.ref_name }}

      - name: Supprimer l'ancien tag 'latest' si n√©cessaire
        if: env.IS_LATEST == 'true'
        run: |
          echo "üóëÔ∏è Suppression de l'ancien tag 'latest'..."
          # Supprimer le tag latest local et distant s'il existe
          if git tag -l | grep -q "^latest$"; then
            git tag -d latest || true
            git push origin :refs/tags/latest || true
            echo "‚úÖ Ancien tag 'latest' supprim√©"
          else
            echo "‚ÑπÔ∏è Aucun tag 'latest' existant √† supprimer"
          fi

      - name: Cr√©er les tags Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          echo "üè∑Ô∏è Cr√©ation du tag principal: ${{ env.FULL_VERSION }}"
          git tag ${{ env.FULL_VERSION }}
          git push origin ${{ env.FULL_VERSION }}
          
          # Cr√©er le tag latest si c'est une release principale
          if [[ "${{ env.IS_LATEST }}" == "true" ]]; then
            echo "üè∑Ô∏è Cr√©ation du tag 'latest'"
            git tag latest
            git push origin latest
          fi

      - name: Cr√©er la GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.FULL_VERSION }}
          name: "Release ${{ env.FULL_VERSION }}"
          body: |
            ## üìã Changelog
            
            ${{ env.CHANGELOG }}
            
            ## üè∑Ô∏è Tags
            - **Version**: `${{ env.FULL_VERSION }}`${{ env.IS_LATEST == 'true' && format('{0}- **Latest**: `latest`', '
            ') || '' }}
            
            ## üì¶ Docker Package
            
            ```bash
            # Pull par version sp√©cifique
            docker pull ghcr.io/baptiste-ferrand/template-release:${{ env.FULL_VERSION }}
            ${{ env.IS_LATEST == 'true' && format('{0}# Pull latest stable{0}docker pull ghcr.io/baptiste-ferrand/template-release:latest', '
            ') || '' }}
            ```
            
            ## üì¶ NPM Package (si applicable)
            
            ```bash
            # Installation par version sp√©cifique
            npm install your-package-name@${{ env.FULL_VERSION }}
            ${{ env.IS_LATEST == 'true' && format('{0}# Installation latest stable{0}npm install your-package-name@latest', '
            ') || '' }}
            ```
            
            ## ‚ÑπÔ∏è Informations
            
            - **Branche source**: `${{ github.event.pull_request.head.ref }}`
            - **Branche cible**: `${{ github.base_ref }}`
            - **Type de release**: ${{ env.IS_LATEST == 'true' && '**Stable** üéØ' || '**Pre-production** üß™' }}
            - **Auteur de la PR**: @${{ github.event.pull_request.user.login }}
          prerelease: ${{ env.IS_LATEST != 'true' }}
          make_latest: ${{ env.IS_LATEST == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-deploy-image:
    needs: versioning-and-release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout du d√©p√¥t
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: V√©rifier les informations de build
        run: |
          echo "üîç Informations de build:"
          echo "- Version: ${{ needs.versioning-and-release.outputs.full_tag }}"
          echo "- Est latest: ${{ needs.versioning-and-release.outputs.is_latest }}"
          echo "- Branche: ${{ github.ref_name }}"

      - name: Connexion √† GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Activer Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pr√©parer les tags Docker
        id: prepare_tags
        run: |
          TAGS="ghcr.io/baptiste-ferrand/template-release:${{ needs.versioning-and-release.outputs.full_tag }}"
          
          if [[ "${{ needs.versioning-and-release.outputs.is_latest }}" == "true" ]]; then
            TAGS="${TAGS},ghcr.io/baptiste-ferrand/template-release:latest"
            echo "üè∑Ô∏è Tags Docker: version + latest"
          else
            echo "üè∑Ô∏è Tags Docker: version uniquement"
          fi
          
          echo "DOCKER_TAGS=${TAGS}" >> $GITHUB_ENV
          echo "Tags pr√©par√©s: ${TAGS}"

      - name: Construire et pousser l'image Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64/v8
          tags: ${{ env.DOCKER_TAGS }}
          labels: |
            org.opencontainers.image.title=Your Node.js Application
            org.opencontainers.image.description=Node.js application with automated versioning
            org.opencontainers.image.version=${{ needs.versioning-and-release.outputs.full_tag }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.source=${{ github.event.repository.clone_url }}

      - name: R√©sum√© du d√©ploiement
        run: |
          echo "## üéâ D√©ploiement r√©ussi!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Package cr√©√©" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.versioning-and-release.outputs.full_tag }}\`" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.versioning-and-release.outputs.is_latest }}" == "true" ]]; then
            echo "- **Latest**: \`latest\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üê≥ Commandes Docker" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/baptiste-ferrand/template-release:${{ needs.versioning-and-release.outputs.full_tag }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.versioning-and-release.outputs.is_latest }}" == "true" ]]; then
            echo "docker pull ghcr.io/baptiste-ferrand/template-release:latest" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã package.json" >> $GITHUB_STEP_SUMMARY
          echo "- La version dans package.json a √©t√© mise √† jour automatiquement" >> $GITHUB_STEP_SUMMARY